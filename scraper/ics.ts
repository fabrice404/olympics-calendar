// BEGIN:VCALENDAR
// VERSION:2.0
// PRODID:-//fabrice404//olympics-calendar//archery/AUS//EN
// X-WR-CALNAME:ðŸ‡¦ðŸ‡º Australia Archery | Paris 2024
// NAME:ðŸ‡¦ðŸ‡º Australia Archery | Paris 2024
// BEGIN:VEVENT
// UID:20240725T073000Z-archery-WOMENS-INDIVIDUAL-RANKING-ROUND
// DTSTAMP:20240725T073000Z
// DTSTART:20240725T073000Z
// DTEND:20240725T103000Z
// DESCRIPTION:Archery - Women's Individual Ranking Round\nðŸ‡¨ðŸ‡³ AN
//   Qixuan\nðŸ‡²ðŸ‡½ Alejandra VALENCIA\nðŸ‡²ðŸ‡© Alexandra MIRCA\nðŸ‡µðŸ‡· Alondra
//   RIVERA\nðŸ‡«ðŸ‡· Amelie CORDEAU\nðŸ‡§ðŸ‡· Ana Luiza SLIACHTICAS CAETANO\nðŸ‡¨ðŸ‡´ Ana
//   RENDON MARTINEZ\nðŸ‡²ðŸ‡½ Ana VAZQUEZ\nðŸ‡²ðŸ‡½ Angela RUIZ\nðŸ‡®ðŸ‡³ Ankita
//   BHAKAT\nðŸ‡²ðŸ‡¾ Ariana Nur Dania MOHAMAD ZAIRI\nðŸ‡®ðŸ‡³ Bhajan KAUR\nðŸ‡¬ðŸ‡§
//   Bryony PITMAN\nðŸ‡¹ðŸ‡¼ CHIU Yi-Ching\nðŸ‡«ðŸ‡· Caroline LOPEZ\nðŸ‡ºðŸ‡¸ Casey
//   KAUFHOLD\nðŸ‡ºðŸ‡¸ Catalina GNORIEGA\nðŸ‡©ðŸ‡ª Charline SCHWARZ\nðŸ‡®ðŸ‡¹ Chiara
//   REBAGLIATI\nðŸ‡®ðŸ‡³ Deepika KUMARI\nðŸ‡¸ðŸ‡° Denisa BARANKOVA\nðŸ‡®ðŸ‡© Diananda
//   CHOIRUNISA\nðŸ‡ªðŸ‡¸ Elia CANALES\nðŸ‡¹ðŸ‡· Elif Berra GOKKIR\nðŸ‡¦ðŸ‡¹ Elisabeth
//   STRAKA\nðŸ‡¬ðŸ‡³ Fatoumata SYLLA\nðŸ‡³ðŸ‡± Gaby SCHLOESSER\nðŸ‡¸ðŸ‡² Giorgia
//   CESARINI\nðŸ‡°ðŸ‡· JEON Hunyoung\nðŸ‡ªðŸ‡¬ Jana ALI\nðŸ‡ºðŸ‡¸ Jennifer MUCINO\nðŸ‡©ðŸ‡ª
//   Katharina BAUER\nðŸ‡©ðŸ‡° Kirstine DANSTRUP ANDERSEN\nðŸ‡¹ðŸ‡¼ LEI
//   Chien-Ying\nðŸ‡¨ðŸ‡³ LI Jiaman\nðŸ‡¹ðŸ‡¼ LI Tsai-Chi\nðŸ‡°ðŸ‡· LIM Sihyeon\nðŸ‡¦ðŸ‡º
//   Laura PAEGLIS\nðŸ‡³ðŸ‡± Laura van der WINKEL\nðŸ‡«ðŸ‡· Lisa BARBELIN\nðŸ‡·ðŸ‡´
//   Madalina AMAISTROAIE\nðŸ‡¨ðŸ‡¿ Marie HORACKOVA\nðŸ‡¬ðŸ‡§ Megs HAVERS\nðŸ‡©ðŸ‡ª
//   Michelle KROPPEN\nðŸ‡®ðŸ‡± Mikaella MOSHE\nðŸ‡®ðŸ‡· Mobina FALLAH\nðŸ‡°ðŸ‡· NAM
//   Suhyeon\nðŸ‡¯ðŸ‡µ NODA Satsuki\nðŸ‡²ðŸ‡¾ Nurul Azreena MOHAMAD FAZIL\nðŸ‡¬ðŸ‡§ Penny
//   HEALEY\nðŸ‡³ðŸ‡± Quinty ROEFFEN\nðŸ‡ªðŸ‡ª Reena PARNAT\nðŸ‡®ðŸ‡© Rezza OCTAVIA\nðŸ‡¹ðŸ‡³
//   Rihab ELWALID\nðŸ‡²ðŸ‡¾ Syaqiera MASHAYIKH\nðŸ‡®ðŸ‡© Syifa Nurafifah KAMAL\nðŸ‡»ðŸ‡³
//   Thi Anh Nguyet DO\nðŸ‡ºðŸ‡¦ Veronika MARCHENKO\nðŸ‡¨ðŸ‡¦ Virginie CHENIER\nðŸ‡µðŸ‡±
//   Wioleta MYSZOR\nðŸ‡¨ðŸ‡³ YANG Xiaolei\nðŸ‡¦ðŸ‡¿ Yaylagul RAMAZANOVA\nðŸ‡¸ðŸ‡® Zana
//   PINTARIC\nðŸ‡ºðŸ‡¿ Ziyodakhon ABDUSATTOROVA
// SUMMARY:ðŸ¹ Women's Individual Ranking Round
// LOCATION:Invalides
// END:VEVENT

import { mkdirSync, writeFileSync } from "fs";
import { Calendar } from "./types";
import { getFlag } from "./nocs";


// BEGIN:VCALENDAR
// VERSION:2.0
// PRODID:-//fabrice404//olympics-calendar//3x3-basketball/AUS//EN
// X-WR-CALNAME:ðŸ‡¦ðŸ‡º Australia 3x3 Basketball | Paris 2024
// NAME:ðŸ‡¦ðŸ‡º Australia 3x3 Basketball | Paris 2024
// BEGIN:VEVENT
// UID:20240730T160000Z-3x3-basketball-WOMENS-POOL-ROUND-AUS-CAN
// DTSTAMP:20240730T160000Z
// DTSTART:20240730T160000Z
// DTEND:20240730T162500Z
// DESCRIPTION:3x3 Basketball - Women's Pool Round
// SUMMARY:ðŸ€ AUS ðŸ‡¦ðŸ‡º - ðŸ‡¨ðŸ‡¦ CAN
// LOCATION:La Concorde 1
// END:VEVENT

// END:VCALENDAR

export const generateICSFiles = (calendar: Calendar): void => {

  generateICSFile(calendar, null, null);

  calendar.sports.forEach((sport) => {
    generateICSFile(calendar, sport.key, null);
    calendar.nocs.forEach((noc) => {
      generateICSFile(calendar, sport.key, noc.key);
    });
  });

  calendar.nocs.forEach((noc) => {
    generateICSFile(calendar, null, noc.key);
  });
};


export const generateICSFile = (calendar: Calendar, sportKey: string | null, nocKey: string | null): void => {
  calendar.languages.forEach((lang) => {
    const pathSportKey = sportKey ? sportKey : "all-sports";
    const pathNocKey = nocKey ? nocKey : "calendar"

    const filepath = `../ui/public/data/${lang.code.toLowerCase()}/${pathSportKey.toLowerCase()}/${pathNocKey.toLowerCase()}.ics`;
    mkdirSync(filepath.split('/').slice(0, -1).join('/'), { recursive: true });

    const titleComponents = [];
    if (nocKey) {
      titleComponents.push(`${calendar.nocs.find(n => n.key === nocKey)!.name[lang.code]}`);
    }
    if (sportKey) {
      titleComponents.push(calendar.sports.find(s => s.key === sportKey)!.name[lang.code]);
    }
    titleComponents.push("Milano Cortina 2026");

    const title = titleComponents.join(' - ');

    const lines = [];

    lines.push("BEGIN:VCALENDAR");
    lines.push("VERSION:2.0");
    lines.push(`PRODID:-//fabrice404//olympics-calendar//${lang.code}/${pathSportKey}/${pathNocKey}`);
    lines.push(`X-WR-CALNAME:${title}`);
    lines.push(`NAME:${title}`);

    calendar.events
      .filter((event) => {
        if (sportKey && event.sport !== sportKey) return false;
        if (nocKey) {
          if (event.match) {
            const team1Key = event.match.team1.key;
            const team2Key = event.match.team2.key;
            if (team1Key !== nocKey && team2Key !== nocKey) {
              return false;
            }
          } else {
            return false;
          }
        }
        return true;
      })
      .forEach((event) => {
        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${event.key.replace(/--/g, '-')}`);
        lines.push(`DTSTAMP:${event.start.replace(/[-:]/g, '').replace(/\.\d+Z$/, 'Z')}`);
        lines.push(`DTSTART:${event.start.replace(/[-:]/g, '').replace(/\.\d+Z$/, 'Z')}`);
        lines.push(`DTEND:${event.end.replace(/[-:]/g, '').replace(/\.\d+Z$/, 'Z')}`);
        lines.push(`LOCATION:${event.location[lang.code] || ''}`);

        const sport = calendar.sports.find(s => s.key === event.sport)!;
        lines.push(`DESCRIPTION:${sport.name[lang.code]} - ${event.name[lang.code] || ''}`);
        let summary = `SUMMARY:${event.name[lang.code] || ''}`

        if (event.match) {
          const team1Name = event.match.team1.name[lang.code] || event.match.team1.key;
          const team1Flag = getFlag(event.match.team1.key);
          const team2Name = event.match.team2.name[lang.code] || event.match.team2.key;
          const team2Flag = getFlag(event.match.team2.key);
          if (team1Name && team2Name) {
            lines.push(`SUMMARY:${team1Flag} ${team1Name} - ${team2Name} ${team2Flag}`);
          }
        }

        lines.push(summary);
        lines.push(`END:VEVENT`);

      })

    lines.push("END:VCALENDAR");

    writeFileSync(filepath, lines.join('\n'));
  });
};
